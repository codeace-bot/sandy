name: Deploy to Staging

on:
  push:
    branches:
      - main

# Prevent concurrent deployments
concurrency:
  group: deployment-${{ github.repository }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      APP_NAME: ${{ github.event.repository.name }}
    
    steps:
      - name: üìã Deployment Information
        run: |
          echo "========================================="
          echo "Deploying: ${{ env.APP_NAME }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "========================================="
      
      - name: üß© Validate Secrets
        run: |
          echo "üîç Validating secrets..."
          
          MISSING=false
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå Missing secret: SSH_PRIVATE_KEY"
            MISSING=true
          fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "‚ùå Missing secret: SSH_USER"
            MISSING=true
          fi
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "‚ùå Missing secret: SSH_HOST"
            MISSING=true
          fi

          if [ "$MISSING" = true ]; then
            echo "========================================="
            echo "üö´ Deployment aborted: Missing required secrets."
            echo "Please check repository settings ‚Üí Secrets ‚Üí Actions"
            echo "========================================="
            exit 1
          fi

          echo "‚úÖ All required secrets are present."
      
      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          echo "üì° Adding SSH host to known_hosts..."
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || {
            echo "‚ùå Failed to scan SSH host key for ${{ secrets.SSH_HOST }}"
            exit 1
          }
          
          echo "‚úÖ SSH configuration complete."
      
      - name: üöÄ Deploy Application
        run: |
          echo "Starting deployment for ${{ env.APP_NAME }}..."
          
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "sudo -u frappe /home/frappe/frappe-bench/deploy.sh ${{ env.APP_NAME }}"
          
          echo "Deployment completed"
      
      - name: üßπ Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
      
      - name: ‚úÖ Success Notification
        if: success()
        run: |
          echo "========================================="
          echo "‚úÖ Deployment Successful!"
          echo "App: ${{ env.APP_NAME }}"
          echo "Time: $(date)"
          echo "========================================="
      
      - name: ‚ùå Failure Notification
        if: failure()
        run: |
          echo "========================================="
          echo "‚ùå Deployment Failed!"
          echo "App: ${{ env.APP_NAME }}"
          echo "Please check the logs above for details"
          echo "========================================="
          exit 1
