name: Deploy to Staging

on:
  push:
    branches:
      - main

concurrency:
  group: deployment-${{ github.repository }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      APP_NAME: ${{ github.event.repository.name }}
      SITE: ${{ vars.SITE }}
      BENCH_PATH: ${{ vars.BENCH_PATH }}
      DEPLOY_SCRIPT_PATH: ${{ vars.DEPLOY_SCRIPT_PATH }}

    steps:
      - name: ğŸ“‹ Deployment Information
        run: |
          echo "========================================="
          echo "ğŸ“¦ Deploying: ${{ env.APP_NAME }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ”¢ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸŒ Site: ${{ env.SITE }}"
          echo "ğŸ§± Bench Path: ${{ env.BENCH_PATH }}"
          echo "ğŸ“œ Script Path: ${{ env.DEPLOY_SCRIPT_PATH }}"
          echo "========================================="

      - name: ğŸ§© Validate Secrets & Variables
        run: |
          echo "ğŸ” Validating configuration..."
          MISSING=false

          # Validate secrets
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Missing secret: SSH_PRIVATE_KEY"; MISSING=true
          fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "âŒ Missing secret: SSH_USER"; MISSING=true
          fi
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "âŒ Missing secret: SSH_HOST"; MISSING=true
          fi

          # Validate variables
          if [ -z "${{ vars.SITE }}" ]; then
            echo "âŒ Missing variable: SITE"; MISSING=true
          fi
          if [ -z "${{ vars.BENCH_PATH }}" ]; then
            echo "âŒ Missing variable: BENCH_PATH"; MISSING=true
          fi
          if [ -z "${{ vars.DEPLOY_SCRIPT_PATH }}" ]; then
            echo "âŒ Missing variable: DEPLOY_SCRIPT_PATH"; MISSING=true
          fi

          if [ "$MISSING" = true ]; then
            echo "ğŸš« Deployment aborted: missing configuration."
            exit 1
          fi

          echo "âœ… All secrets and variables verified successfully."

      - name: ğŸ”‘ Setup SSH Access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          echo "ğŸ“¡ Scanning and adding host key..."
          if ! ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null; then
            echo "âŒ Failed to add SSH host key for ${{ secrets.SSH_HOST }}"
            exit 1
          fi

          echo "âœ… SSH setup complete."

      - name: ğŸš€ Deploy Application
        run: |
          echo "========================================="
          echo "ğŸš€ Starting deployment for ${{ env.APP_NAME }}..."
          echo "========================================="

          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "sudo -u frappe bash '${{ env.DEPLOY_SCRIPT_PATH }}' '${{ env.APP_NAME }}' '${{ env.SITE }}' '${{ env.BENCH_PATH }}'"

          echo "âœ… Remote deployment completed successfully."

      - name: ğŸ§¾ Fetch Remote Logs (on failure)
        if: failure()
        run: |
          echo "ğŸ“¥ Attempting to fetch remote deployment log..."
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "tail -n 50 '${{ env.BENCH_PATH }}/logs/deploy.log' || echo 'No log file found.'"

      - name: ğŸ§¹ Cleanup SSH Key
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up SSH keys..."
          rm -f ~/.ssh/deploy_key

      - name: âœ… Success Notification
        if: success()
        run: |
          echo "========================================="
          echo "âœ… Deployment Successful!"
          echo "ğŸ“¦ App: ${{ env.APP_NAME }}"
          echo "ğŸŒ Site: ${{ env.SITE }}"
          echo "ğŸ§± Bench: ${{ env.BENCH_PATH }}"
          echo "ğŸ•’ Time: $(date)"
          echo "========================================="

      - name: âŒ Failure Notification
        if: failure()
        run: |
          echo "========================================="
          echo "âŒ Deployment Failed!"
          echo "ğŸ“¦ App: ${{ env.APP_NAME }}"
          echo "ğŸŒ Site: ${{ env.SITE }}"
          echo "ğŸ§± Bench: ${{ env.BENCH_PATH }}"
          echo "âš ï¸ Please check the logs above for details."
          echo "========================================="
          exit 1
